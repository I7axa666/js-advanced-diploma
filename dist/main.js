!function(){"use strict";function t(t,e){const{character:i}=e.find((e=>e.position===t));return i}function e(t){return["bowman","swordsman","magician"].includes(t)?"white":"black"}function i(t,e){const i=Math.floor(t/8),s=t%8,a=[],r=[{row:-1,col:0},{row:1,col:0},{row:0,col:-1},{row:0,col:1},{row:-1,col:-1},{row:-1,col:1},{row:1,col:-1},{row:1,col:1}];for(const t of r)for(let r=1;r<=e;r++){const e=i+t.row*r,h=s+t.col*r;e>=0&&e<8&&h>=0&&h<8&&a.push(8*e+h)}return a}function s(t,e){return"swordsman"===t||"undead"===t?i(e,4):"bowman"===t||"vampire"===t?i(e,2):"magician"===t||"daemon"===t?i(e,1):void 0}function a(t,e){return"swordsman"===t||"undead"===t?i(e,1):"bowman"===t||"vampire"===t?i(e,2):"magician"===t||"daemon"===t?i(e,4):void 0}function r(t,e){return t.filter((t=>e.characters.some((e=>t.character.type===e.type))))}class h{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const i=document.createElement("div");i.classList.add("cell","map-tile","map-tile-"+(e=t,this.boardSize,0===e?"top-left":7===e?"top-right":56===e?"bottom-left":63===e?"bottom-right":e>0&e<7?"top":e>56&e<63?"bottom":e%8==0?"left":e%8==7?"right":"center")),i.addEventListener("mouseenter",(t=>this.onCellEnter(t))),i.addEventListener("mouseleave",(t=>this.onCellLeave(t))),i.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(i)}var e;this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const i of t){const t=this.boardEl.children[i.position],s=document.createElement("div");s.classList.add("character",i.character.type);const a=document.createElement("div");a.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((e=i.character.health)<15?"critical":e<50?"normal":"high")),r.style.width=`${i.character.health}%`,a.appendChild(r),s.appendChild(a),t.appendChild(s)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t,e="yellow"){this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((i=>{const s=this.cells[t],a=document.createElement("span");a.textContent=e,a.classList.add("damage"),s.appendChild(a),a.addEventListener("animationend",(()=>{s.removeChild(a),i()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}function o(t,e){const i=t+Math.random()*(e+1-t);return Math.floor(i)}function l(t,e){const i=[];for(let s=0;s<e;s++){const e=t[Math.floor(Math.random()*t.length)];i.includes(e)?s--:i.push(e)}return i}class c{constructor(t){this.characters=[...t]}}function*n(t,e){const i=o(1,e),s=new(0,t[o(0,t.length-1)])(i);yield s,yield*n(t,e)}function d(t,e,i){const s=[],a=n(t,e);for(let t=0;t<i;t++)s.push(a.next().value);return new c(s)}class m{constructor(t,e="generic"){if(this.level=t,this.attack=0,this.defence=0,this.health=50,this.type=e,"Character"===new.target.name)throw new Error("Нельзя создать персонаж из базового класса")}levelUp(){this.level+=1,this.attack=Math.round(Math.max(this.attack,this.attack*(80+this.health)/100)),this.defence=Math.round(Math.max(this.defence,this.defence*(80+this.health)/100));const t=this.health+80;this.health=t>100?100:t}}class v{constructor(t,e){if(!(t instanceof m))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}class p extends m{constructor(t,e="bowman"){super(t,e),this.attack=25,this.defence=25}}class u extends m{constructor(t,e="daemon"){super(t,e),this.attack=10,this.defence=10}}class C extends m{constructor(t,e="magician"){super(t,e),this.attack=10,this.defence=40}}class w extends m{constructor(t,e="swordsman"){super(t,e),this.attack=40,this.defence=10}}class g extends m{constructor(t,e="undead"){super(t,e),this.attack=40,this.defence=10}}class f extends m{constructor(t,e="vampire"){super(t,e),this.attack=25,this.defence=25}}class y{static from(t){const e={bowman:p,daemon:u,magician:C,swordsman:w,undead:g,vampire:f},i=[];return t.forEach((t=>{const s=new e[t.character.type](t.character.level);for(const e in t.character)s.key=t.character[e];i.push(new v(s,t.position))})),i}}var P={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};const L=new h;L.bindToDOM(document.querySelector("#game-container"));const b=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),k=new class{constructor(t,e){this.gamePlay=t,this.showCellTooltip=this.gamePlay.showCellTooltip.bind(this.gamePlay),this.stateService=e,this.whiteTeam=d([p,w,C],1,3),this.blackTeam=d([f,g,u],1,3),this.whitePosition=[0,1,8,9,16,17,24,25,32,33,40,41,48,49,56,57],this.blackPosition=[6,7,14,15,22,23,30,31,38,39,46,47,54,55,62,63],this.randomListWhitePosition=l(this.whitePosition,this.whiteTeam.characters.length),this.randomListBlackPosition=l(this.blackPosition,this.blackTeam.characters.length),this.positionCharacters=[],this.onCellEnter=this.onCellEnter.bind(this),this.onCellLeave=this.onCellLeave.bind(this),this.onCellClick=this.onCellClick.bind(this),this.startPositions=this.startPositions.bind(this),this.newGame=this.newGame.bind(this),this.saveGame=this.saveGame.bind(this),this.loadGame=this.loadGame.bind(this),this.activeCell=void 0,this.character=void 0,this.characterForPreview=void 0,this.attack=!1,this.move=!1}init(){localStorage.length>0?this.loadGame():(this.gamePlay.drawUi(Object.values(P)[0]),this.startPositions()),this.playerListener()}playerListener(){this.gamePlay.addCellEnterListener(this.onCellEnter),this.gamePlay.addCellLeaveListener(this.onCellLeave),this.gamePlay.addCellClickListener(this.onCellClick),this.gamePlay.addNewGameListener(this.newGame),this.gamePlay.addSaveGameListener(this.saveGame),this.gamePlay.addLoadGameListener(this.loadGame)}onCellClick(i){const s=document.querySelectorAll(".cell");if(0===s[i].childNodes.length||this.move||this.attack||(this.character=t(i,this.positionCharacters),"white"===e(this.character.type)?this.activeCell===i?(this.gamePlay.deselectCell(this.activeCell),this.activeCell=void 0,this.character=void 0):void 0===this.activeCell?(this.gamePlay.selectCell(i),this.activeCell=i):void 0!==this.activeCell&&(this.gamePlay.deselectCell(this.activeCell),this.gamePlay.selectCell(i),this.activeCell=i):void 0===this.activeCell&&h.showError("Персонаж чужой команды")),0===s[i].childNodes.length&&this.move){const t=this.positionCharacters.findIndex((t=>t.position===this.activeCell));this.positionCharacters[t].position=i,this.gamePlay.redrawPositions(this.positionCharacters),this.clearSelected(i),this.computerActivity()}if(0!==s[i].childNodes.length&&this.attack){const t=this.positionCharacters.findIndex((t=>t.position===i));this.gamePlay.showDamage(i,this.character.attack).then((()=>{const e=this.character.attack,i=this.positionCharacters[t].character.defence;if(this.positionCharacters[t].character.health-=Math.round(Math.max(e-i,.1*e)),this.positionCharacters[t].character.health<0&&this.positionCharacters.splice(t,1),this.gamePlay.redrawPositions(this.positionCharacters),r(this.positionCharacters,this.blackTeam).length>0)this.computerActivity();else{const t=r(this.positionCharacters,this.whiteTeam),{level:e}=t[0].character;4===e?this.gameOver("white"):this.levelUp(t)}}))}}onCellEnter(i){0!==document.querySelectorAll(".cell")[i].childNodes.length&&(this.characterForPreview=t(i,this.positionCharacters),this.gamePlay.showCellTooltip(`🎖 ${this.characterForPreview.level}⚔ ${this.characterForPreview.attack}🛡 ${this.characterForPreview.defence}❤${this.characterForPreview.health}`,i),"white"===e(this.characterForPreview.type)&&this.gamePlay.setCursor("pointer")),this.character&&(s(this.character.type,this.activeCell).includes(i)&&void 0===this.characterForPreview?(this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(i,"green"),this.move=!0):a(this.character.type,this.activeCell).includes(i)&&this.characterForPreview&&"black"===e(this.characterForPreview.type)?(this.gamePlay.setCursor("crosshair"),this.gamePlay.selectCell(i,"red"),this.attack=!0):this.characterForPreview&&"white"===e(this.characterForPreview.type)?this.gamePlay.setCursor("pointer"):this.gamePlay.setCursor("not-allowed"))}onCellLeave(t){this.gamePlay.hideCellTooltip(t),this.gamePlay.setCursor("auto"),this.characterForPreview=void 0,this.attack=!1,this.move=!1,this.activeCell!==t&&this.gamePlay.deselectCell(t)}startPositions(){this.positionCharacters=[];for(let t=0;t<this.whiteTeam.characters.length;t++)this.positionCharacters.push(new v(this.whiteTeam.characters[t],this.randomListWhitePosition[t]));for(let t=0;t<this.blackTeam.characters.length;t++)this.positionCharacters.push(new v(this.blackTeam.characters[t],this.randomListBlackPosition[t]));this.gamePlay.redrawPositions(this.positionCharacters)}clearSelected(t){this.gamePlay.deselectCell(this.activeCell),this.gamePlay.deselectCell(t),this.gamePlay.selectCell(t),this.activeCell=t,this.gamePlay.selectCell(this.activeCell)}computerActivity(){const t=r(this.positionCharacters,this.blackTeam),e=r(this.positionCharacters,this.whiteTeam);for(let i=0;i<t.length;i++){const s=a(t[i].character.type,t[i].position);for(let a=0;a<e.length;a++)if(s.includes(e[a].position)){const s=this.positionCharacters.findIndex((t=>t.position===e[a].position));return this.gamePlay.showDamage(e[a].position,t[i].character.attack).then((()=>{const h=t[i].character.attack,o=this.positionCharacters[s].character.defence;this.positionCharacters[s].character.health-=Math.round(Math.max(h-o,.1*h)),this.positionCharacters[s].character.health<0&&(this.positionCharacters.splice(s,1),this.gamePlay.deselectCell(e[a].position),e[a].position===this.activeCell&&(this.activeCell=void 0,this.character=void 0,this.attack=!1,this.gamePlay.setCursor("not-allowed"),t.forEach((t=>{this.gamePlay.deselectCell(t.position)})))),this.gamePlay.redrawPositions(this.positionCharacters),0===r(this.positionCharacters,this.whiteTeam).length&&this.gameOver("black")}))}}this.computerMove(t),this.gamePlay.redrawPositions(this.positionCharacters)}computerMove(t){const e=t[o(0,t.length-1)],i=this.positionCharacters.findIndex((t=>t.position===e.position)),a=s(e.character.type,e.position),r=[];for(let t=0;t<a.length;t++)-1===this.positionCharacters.findIndex((e=>e.position===a[t]))&&r.push(a[t]);this.positionCharacters[i].position=r[o(0,r.length-1)]}levelUp(t){this.whiteTeam.characters=[],t.forEach((t=>{t.character.levelUp(),this.whiteTeam.characters.push(t.character)}));const{level:e}=t[0].character;this.blackTeam=d([f,g,u],1,3),this.gamePlay.drawUi(Object.values(P)[e-1]),this.startPositions()}gameOver(t="white"){document.querySelector(".board").style.pointerEvents="none","white"===t?h.showMessage("You win"):h.showMessage("Game over")}newGame(){this.whiteTeam=d([p,w,C],1,3),this.blackTeam=d([f,g,u],1,3),this.randomListWhitePosition=l(this.whitePosition,this.whiteTeam.characters.length),this.randomListBlackPosition=l(this.blackPosition,this.blackTeam.characters.length),this.gamePlay.drawUi(Object.values(P)[0]),this.startPositions()}loadGame(){this.positionCharacters=y.from(this.stateService.load());const t=[],i=[];this.positionCharacters.forEach((s=>{"white"===e(s.character.type)?t.push(s.character):i.push(s.character)})),this.whiteTeam=new c(t),this.blackTeam=new c(i);const s=this.whiteTeam.characters[0].level-1;this.gamePlay.drawUi(Object.values(P)[s]),this.gamePlay.redrawPositions(this.positionCharacters)}saveGame(){localStorage.clear(),this.stateService.save(this.positionCharacters)}}(L,b);k.init()}();